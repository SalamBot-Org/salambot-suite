# ğŸš€ SalamBot Intelligent Release Workflow v2.2
# ImplÃ©mentation de la StratÃ©gie Optimale: Hybrid Versioning + Business Value
# @author      SalamBot Team (contact: info@salambot.ma)
# @created     2025-06-04
# @updated     2025-06-04
# @project     SalamBot - AI CRM for Moroccan SMEs

name: ğŸ¤– SalamBot Intelligent Release

on:
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Type de release'
        required: true
        default: 'phase1'
        type: choice
        options:
          - phase1
          - phase2
          - hotfix
          - custom
      version:
        description: 'Version (pour custom/hotfix)'
        required: false
        type: string
      description:
        description: 'Description (pour custom)'
        required: false
        type: string
      features:
        description: 'FonctionnalitÃ©s (sÃ©parÃ©es par des virgules)'
        required: false
        type: string
      create_github_release:
        description: 'CrÃ©er une GitHub Release'
        required: false
        default: true
        type: boolean
      push_tags:
        description: 'Pousser les tags vers le remote'
        required: false
        default: true
        type: boolean

  # DÃ©clenchement automatique sur merge vers main avec label 'release'
  pull_request:
    types: [closed]
    branches: [main]

env:
  NODE_VERSION: '20.18.0'
  PNPM_VERSION: '9.1.2'

jobs:
  # ğŸ” DÃ©tection automatique du type de release
  detect-release-type:
    if: github.event_name == 'pull_request' && github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    outputs:
      should_release: ${{ steps.detect.outputs.should_release }}
      release_type: ${{ steps.detect.outputs.release_type }}
      version: ${{ steps.detect.outputs.version }}
    steps:
      - name: ğŸ” DÃ©tection du type de release
        id: detect
        run: |
          # Analyse des labels PR pour dÃ©terminer le type de release
          labels="${{ join(github.event.pull_request.labels.*.name, ' ') }}"
          echo "Labels PR: $labels"
          
          should_release="false"
          release_type=""
          version=""
          
          if [[ "$labels" == *"release:phase1"* ]]; then
            should_release="true"
            release_type="phase1"
          elif [[ "$labels" == *"release:phase2"* ]]; then
            should_release="true"
            release_type="phase2"
          elif [[ "$labels" == *"release:hotfix"* ]]; then
            should_release="true"
            release_type="hotfix"
          elif [[ "$labels" == *"release"* ]]; then
            should_release="true"
            release_type="custom"
          fi
          
          echo "should_release=$should_release" >> $GITHUB_OUTPUT
          echo "release_type=$release_type" >> $GITHUB_OUTPUT
          echo "version=$version" >> $GITHUB_OUTPUT

  # ğŸ§ª Tests et validation avant release
  pre-release-validation:
    if: |
      (github.event_name == 'workflow_dispatch') ||
      (needs.detect-release-type.outputs.should_release == 'true')
    needs: [detect-release-type]
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: ğŸ“¥ Installation des dÃ©pendances
        run: pnpm install --frozen-lockfile

      - name: ğŸ” Lint du code
        run: pnpm lint

      - name: ğŸ§ª Tests unitaires
        run: pnpm test

      - name: ğŸ—ï¸ Build du projet
        run: pnpm build

      - name: ğŸ”’ Audit de sÃ©curitÃ©
        run: pnpm audit --audit-level moderate
        continue-on-error: true

      - name: ğŸ“Š VÃ©rification de la couverture de tests
        run: |
          # VÃ©rification que la couverture est >= 85%
          echo "ğŸ§ª VÃ©rification de la couverture de tests..."
          # TODO: ImplÃ©menter la vÃ©rification de couverture

  # ğŸš€ CrÃ©ation de la release intelligente
  intelligent-release:
    needs: [detect-release-type, pre-release-validation]
    if: |
      (github.event_name == 'workflow_dispatch') ||
      (needs.detect-release-type.outputs.should_release == 'true')
    runs-on: ubuntu-latest
    outputs:
      tag_name: ${{ steps.create-tag.outputs.tag_name }}
      release_notes: ${{ steps.create-tag.outputs.release_notes }}
    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: âš™ï¸ Configuration Git
        run: |
          git config --global user.name "SalamBot Release Bot"
          git config --global user.email "release-bot@salambot.ma"

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: ğŸ“¥ Installation des dÃ©pendances
        run: pnpm install --frozen-lockfile

      - name: ğŸ·ï¸ CrÃ©ation du tag intelligent
        id: create-tag
        run: |
          # DÃ©termination du type de release
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            RELEASE_TYPE="${{ github.event.inputs.release_type }}"
            VERSION="${{ github.event.inputs.version }}"
            DESCRIPTION="${{ github.event.inputs.description }}"
            FEATURES="${{ github.event.inputs.features }}"
          else
            RELEASE_TYPE="${{ needs.detect-release-type.outputs.release_type }}"
            VERSION="${{ needs.detect-release-type.outputs.version }}"
          fi
          
          echo "ğŸ¯ Type de release: $RELEASE_TYPE"
          
          # ExÃ©cution du script de tagging intelligent
          if [ "$RELEASE_TYPE" = "custom" ] && [ -n "$VERSION" ]; then
            if [ -n "$FEATURES" ]; then
              IFS=',' read -ra FEATURE_ARRAY <<< "$FEATURES"
              pnpm tag:custom "$VERSION" "minor" "$DESCRIPTION" "${FEATURE_ARRAY[@]}"
            else
              pnpm tag:custom "$VERSION" "minor" "$DESCRIPTION"
            fi
          else
            pnpm tag:$RELEASE_TYPE
          fi
          
          # RÃ©cupÃ©ration du tag crÃ©Ã©
          TAG_NAME=$(git describe --tags --abbrev=0)
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          
          # GÃ©nÃ©ration des release notes
          RELEASE_NOTES_FILE="docs/releases/${TAG_NAME}.md"
          if [ -f "$RELEASE_NOTES_FILE" ]; then
            echo "release_notes<<EOF" >> $GITHUB_OUTPUT
            cat "$RELEASE_NOTES_FILE" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ“¤ Push des changements
        if: github.event.inputs.push_tags != 'false'
        run: |
          # Commit des changements (package.json, CHANGELOG.md)
          git add .
          git commit -m "chore: release ${{ steps.create-tag.outputs.tag_name }}" || echo "Rien Ã  commiter"
          
          # Push du commit et des tags
          git push origin main
          git push origin --tags

  # ğŸ“‹ CrÃ©ation de la GitHub Release
  github-release:
    needs: [intelligent-release]
    if: github.event.inputs.create_github_release != 'false'
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸš€ CrÃ©ation de la GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ needs.intelligent-release.outputs.tag_name }}
          release_name: "ğŸš€ SalamBot ${{ needs.intelligent-release.outputs.tag_name }}"
          body: |
            ${{ needs.intelligent-release.outputs.release_notes }}
            
            ---
            
            **ğŸ¤– Release automatique gÃ©nÃ©rÃ©e par SalamBot Intelligent Release System v2.2**
            
            ### ğŸ“Š MÃ©triques de Build
            - âœ… Tests: PassÃ©s
            - âœ… Lint: ValidÃ©  
            - âœ… Build: RÃ©ussi
            - âœ… SÃ©curitÃ©: AuditÃ©e
            
            ### ğŸ”— Liens Utiles
            - ğŸ“š [Documentation](https://github.com/${{ github.repository }}/tree/${{ needs.intelligent-release.outputs.tag_name }}/docs)
            - ğŸ› [Signaler un bug](https://github.com/${{ github.repository }}/issues/new?template=bug_report.md)
            - ğŸ’¡ [Demander une fonctionnalitÃ©](https://github.com/${{ github.repository }}/issues/new?template=feature_request.md)
            
            **ğŸ“§ Contact:** info@salambot.ma  
            **ğŸŒ Site web:** https://salambot.ma
          draft: false
          prerelease: ${{ contains(needs.intelligent-release.outputs.tag_name, 'rc') || contains(needs.intelligent-release.outputs.tag_name, 'beta') || contains(needs.intelligent-release.outputs.tag_name, 'alpha') }}

  # ğŸ“Š MÃ©triques et notifications post-release
  post-release-metrics:
    needs: [intelligent-release, github-release]
    if: always() && needs.intelligent-release.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“Š Collecte des mÃ©triques de release
        run: |
          echo "ğŸ‰ Release ${{ needs.intelligent-release.outputs.tag_name }} crÃ©Ã©e avec succÃ¨s!"
          echo "ğŸ“… Date: $(date)"
          echo "ğŸ·ï¸ Tag: ${{ needs.intelligent-release.outputs.tag_name }}"
          echo "ğŸ”— Repository: ${{ github.repository }}"
          echo "ğŸ‘¤ DÃ©clenchÃ© par: ${{ github.actor }}"
          
          # TODO: Envoyer les mÃ©triques vers un systÃ¨me de monitoring
          # TODO: Notifier l'Ã©quipe via Slack/Teams

      - name: ğŸ”” Notification Slack (optionnel)
        if: env.SLACK_WEBHOOK_URL != ''
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          curl -X POST -H 'Content-type: application/json' \
            --data '{
              "text": "ğŸš€ Nouvelle release SalamBot!",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*ğŸš€ SalamBot Release ${{ needs.intelligent-release.outputs.tag_name }}*\n\nâœ… Release crÃ©Ã©e avec succÃ¨s!\nğŸ”— <https://github.com/${{ github.repository }}/releases/tag/${{ needs.intelligent-release.outputs.tag_name }}|Voir la release>"
                  }
                }
              ]
            }' \
            $SLACK_WEBHOOK_URL

  # ğŸš¨ Gestion des erreurs et rollback
  error-handling:
    needs: [intelligent-release]
    if: failure()
    runs-on: ubuntu-latest
    steps:
      - name: ğŸš¨ Gestion des erreurs
        run: |
          echo "âŒ Erreur lors de la crÃ©ation de la release"
          echo "ğŸ” VÃ©rifiez les logs des jobs prÃ©cÃ©dents"
          echo "ğŸ“§ Contact: info@salambot.ma"
          
          # TODO: ImplÃ©menter la logique de rollback si nÃ©cessaire
          # TODO: Notifier l'Ã©quipe de l'erreur

      - name: ğŸ”” Notification d'erreur
        if: env.SLACK_WEBHOOK_URL != ''
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          curl -X POST -H 'Content-type: application/json' \
            --data '{
              "text": "ğŸš¨ Erreur lors de la release SalamBot!",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*ğŸš¨ Erreur Release SalamBot*\n\nâŒ La crÃ©ation de la release a Ã©chouÃ©\nğŸ”— <https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|Voir les logs>\n\nğŸ‘¥ <@channel> Intervention requise!"
                  }
                }
              ]
            }' \
            $SLACK_WEBHOOK_URL